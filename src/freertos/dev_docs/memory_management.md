# メモリ管理

RTOSカーネルは、タスク、キュー、ミューテックス、ソフトウェアタイマー、
セマフォ、イベントグループが生成されるたびにRAMを必要とします。RAMは
RTOS APIのオブジェクト作成関数内でRTOSヒープから自動的に動的に
割り当てられるか、アプリケーションの作者により提供されます。

RTOSオブジェクトが動的に生成される場合、標準Cライブラリのmalloc()
関数とfree()関数をこの目的で使用することができるかもしれません。
しかし、これらの関数は

- 組み込みシステムでは常に使用できるわけではありません
- 貴重なコード空間を占有します
- スレッドセーフではありません
- 決定論的ではありません（関数の実行にかかる時間は呼び出しごとに
  異なります）

そのため代わりとなるメモリ割り当ての実装が必要になることが多いです。

組み込み/リアルタイムシステムはシステムごとにまったく異なるRAMと
タイミングの要件があるばあいがあります。そのため、単一のRAM割り当て
アルゴリズムは一部のアプリケーションにしか適切ではありません。

この問題を回避するため、FreeRTOSはメモリ割り当てAPIをポータブル
レイヤに置いています。ポータブルレイヤはRTOSのコア機能を実装する
ソースファイルの外側にあり、開発中のリアルタイムシステムに適した
アプリケーション固有の実装を提供することができます。RAMを必要と
する時、RTOSカーネルはmalloc()ではなくpvPortMalloc()を呼び出します。RAMが解放された時、RTOSカーネルはfree()ではなくvPortFree()を
呼び出します。

FreeRTOSは複雑さと機能に幅がある複数のヒープ管理方式を提供して
います。独自のヒープ実装を提供することも可能です。そして、2つの
ヒープ実装を同時に使用することもできます。2つのヒープ実装を同時に
使用することで、タスクスタックやその他のRTOSオブジェクトを高速な
内部RAMに配置し、アプリケーションデータを低速な外部RAMに配置する
ことができます。

## RTOSソースコードに含まれるメモリ割り当て実装

FreeRTOSには5つのサンプルメモリアロケーション実装が含まれています。
各実装については以下のサブセクションで説明されています。そこでは
提供されている実装のどれを選択するのが最適であるかに関する情報も
含まれています。

提供されている各実装はそれぞれ別のソースファイル（heap_1.c、
heap_2.c、heap_3.c、heap_4.c、heap_5.c）に含まれており、
RTOSソースコードの`Source/Portable/MemMang`ディレクトリにあります。
必要に応じて他の実装を追加することができます。プロジェクトには
これらのソースファイルを同時に1つしか含めていはいけません
（これらのポータブルレイヤの関数により定義されたヒープは、たとえ
独自のヒープ実装を使用するというRTOS選択肢を使用している
アプリケーションであってもRTOSカーネルによって使用されます）。

 以下では：

- heap_1 - 最も単純で、メモリの解放を許さない
- heap_2 - メモリの解放は許すが、隣接する空きブロックを合体させない
- heap_3 - スレッドセーフにするために単に標準のmalloc()とfree()を
  ラップしたもの
- heap_4 - フラグメンテーションを避けるため、隣接する空きブロックを
  合体させる。絶対アドレス配置オプションを含む。
- heap_5 - heap_4と同じで、隣接しない複数のメモリ領域からヒープを
  作成できる


注意:

- FreeRTOSが静的割当てをサポートするようになってから heap_1 は
  あまり有用ではなくなりました。
- より新しい heap_4 の実装が優先されるため、heap_2 はレガシーと
  みなされるようになりました。

<hr/>

## heap_4.c

このスキームはファーストフィットアルゴリズムを使用し、スキーム2とは
異なり、隣接する空きメモリブロックを1つの大きなブロックにまとめます
（合体アルゴリズムを含みます）。

利用可能なヒープ空間の総量は、FreeRTOSConfig.hで定義されるcon`figTOTAL_HEAP_SIZE` により設定されます。FreeRTOSConfig.hの
設定定数である`configAPPLICATION_ALLOCATED_HEAP`を指定すると
ヒープをメモリ内の特定のアドレスに配置できます。

`xPortGetFreeHeapSize()`API関数は関数が呼び出された時点で未割り
当てのヒープ空間のトータルを返します。`xPortGetMinimumEverFreeHeapSize()`
API関数はFreeRTOSアプリケーションが起動したシステムに存在する空き
ヒープ空間の最小値を返します。どちらの関数も未割り当てのメモリが
どのような小ブロックに断片化されているかについての情報は提供しません。

`vPortGetHeapStats()`API関数は追加情報を提供します。以下に示すように、
この関数は以下のheap_t構造体に情報をセットします。

```c
/* Prototype of the vPortGetHeapStats() function. */
void vPortGetHeapStats( HeapStats_t *xHeapStats );

/* Definition of the Heap_stats_t structure. */
typedef struct xHeapStats
{
	size_t xAvailableHeapSpaceInBytes;      /* 現在利用可能なヒープの合計サイズ。すべての空きブロックの合計であり、割当て可能な最大ブロックでｈない */
	size_t xSizeOfLargestFreeBlockInBytes; 	/* vPortGetHeapStats()呼び出し時点におけるヒープ内のすべての空きブロックのバイト単位の最大サイズ */
	size_t xSizeOfSmallestFreeBlockInBytes; /* vPortGetHeapStats()呼び出し時点におけるヒープ内のすべての空きブロックのバイト単位の最小サイズ */
	size_t xNumberOfFreeBlocks;		/* vPortGetHeapStats()呼び出し時点におけるヒープ内の空きブロック数 */
	size_t xMinimumEverFreeBytesRemaining;	/* システム起動以後にヒープに存在したトータル空きメモリ（すべての空きブロックの合計）の最小値. */
	size_t xNumberOfSuccessfulAllocations;	/* 有効なメモリブロックを返したpvPortMalloc()の呼び出し回数 */
	size_t xNumberOfSuccessfulFrees;	/* メモリブロックの解放に成功したvPortFree()の呼び出し回数 */
} HeapStats_t;
```

pvPortCalloc()関数は標準ライブラリのcalloc関数と同じシグネチャを持ちます。
この関数はオブジェクトの配列のためのメモリを割り当て、割り当てられた
ストレージ内のすべてのバイトをゼロに初期化します。割り当てに成功すると
割り当てたメモリブロックの最下位バイトへのポインタを返します。失敗した場合は
NULLポインタを返します。

heap_4は

- アプリケーションがタスク、キュー、セマフォ、ミューテックスなどを繰り返し
  削除する場合でも使用できる
- heap_2の実装に比べて、ランダムサイズのメモリの割り当てと解放があった
  場合でもヒープ空間が複数の小さなブロックにひどく断片化される可能性が
  はるかに低い。
- 決定論的ではないが、標準的なCライブラリのmalloc実装よりもはるかに
  効率的である。

heap_4.cはポータブルレイヤのメモリ割り当てスキームをアプリケーション
コードで（pvPortMalloc()とvPortFree()を呼び出すAPI関数を間接的に呼び
出して間接的に使用するではなく）直接使用したいアプリケーションには特に
有用です。

<hr/>
