# 新規FreeRTOSプロジェクトの作成

## はじめに

FreeRTOSはシンプルで使いやすいように設計されています: すべてのRTOS
ポートに共通な3つのソースファイルとマイクロコントローラ固有の
ソースファイルが1つだけが必要であり、そのAPIはシンプルで直感的で
あるように設計されています。

FreeRTOSは様々なマイクロコントローラアーキテクチャやコンパイラに
移植されています。公式の移植版の各々には公式のデモが付属しており
(少なくとも作成時点では) 開発されたハードウェアプラットフォーム上で
変更することなくコンパイル・実行することができます。

デモプロジェクトは新しいユーザができるだけ早く、最小限の手間で
FreeRTOSを使い始められるようにするために提供されています。

FreeRTOSがサポートしているアーキテクチャは多くの様々なマイクロ
コントローラで使用されています。これは文字通りFreeRTOSは何千もの
異なるマイクロコントローラで使用できることを意味します。この数に
対応するコンパイラの数を掛け合わせ、さらに今後さらに市場に投入される
スターターキットや評価ボードの数を掛け合わせると、最善を尽くしても、
可能な組み合わせのごく一部にしか完全に一致する公式デモプロジェクトを
提供できないことは明らかです。

**新しいFreeRTOS プロジェクトは提供されている設定済みのデモのいずれかかを使い、それをプロジェクトに合うように作成することを常に推奨します。こうすることで、新しいプロジェクトには必要なソースファイルとヘッダファイルがすべて含まれ、プロジェクトの作成者は何もしなくても必要な割り込みサービスルーチンがインストールされます。**

FreeRTOSユーザの中には既存のプロジェクトに適合させる以外の方法で
FreeRTOSプロジェクトを作成する方法を知りたい人もいるかもしれません。
その手順を以下に示します。

## FreeRTOSプロジェクトの構造

FreeRTOSアプリケーションは`vTaskStartScheduler()`が呼び出される
までは非RTOSアプリケーションと同様に起動し実行されます。通常、
`vTaskStartScheduler()`はアプリケーションの`main()`関数から呼び
出されます。RTOSが実行順序を制御するのは**vTaskStartScheduler()の
呼び出し後だけ**です。

RTOSの機能を使用しようとする前に選択したターゲット上でコードが
正しく実行されている（正しいスタートアップコードや正しいリンカ
構成など）ことを確認することを_強く推奨_します。

### ソースファイル

FreeRTOSは標準Cソースファイルとして提供され、プロジェクトの他の
すべてのCファイルと一緒にビルドされます。FreeRTOSのソースファイルは
zipファイルで配布されています。zipファイルのファイルの構成は
[RTOSソースコードの構成](https://www.freertos.org/a00017.html)で
説明されています。

最低限、以下のソースファイルをプロジェクトに含める必要があります：

- `FreeRTOS/Source/tasks.c`
- `FreeRTOS/Source/queue.c`
- `FreeRTOS/Source/list.c`
- `FreeRTOS/Source/portable/[compiler]/[architecture]/port.c`
- `FreeRTOS/Source/portable/MemMang/heap_x.c`（xは1, 2, 3, 4, 5のいずれか）。

port.cファイルを含むディレクトリにアセンブリ言語ファイルも
含まれている場合はアセンブリ言語ファイルも使用する必要があります。

### オプションのソースファイル

ソフトウェアタイマー機能が必要な場は`FreeRTOS/Source/timers.c`を
プロジェクトに追加してください。

イベントグループ機能が必要な場合は`FreeRTOS/Source/event_groups.c`を
プロジェクトに追加してください。

ストリームバッファ機能かメッセージバッファ機能が必要な場合は
`FreeRTOS/Source/stream_buffer.c`をプロジェクトに追加してください。

コルーチン機能が必要な場合は`FreeRTOS/Source/croutine.c`を
プロジェクトに追加してください（コルーチンは非推奨であり、新しい
設計には推奨されないことに注意してください）。

### ヘッダーファイル

以下のディレクトリをコンパイラのインクルードパスに含める必要が
あります（コンパイラはこれらのディレクトリからヘッダファイルを
検索するように指示しなければなりません）：

- `FreeRTOS/Source/include`
- `FreeRTOS/Source/portable/[コンパイラ]/[アーキテクチャ]`
- いずれかのディレクトリに使用する`FreeRTOSConfig.h`ファイルが
  あります。以下の構成ファイルの項を参照してください。

アセンブラのインクルードパスにも同じディレクトリが必要なポートも
あります。

### 構成ファイル

すべてのプロジェクトには`FreeRTOSConfig.h`というファイルも必要です。
FreeRTOSConfig.hはビルドするアプリケーションに合わせてRTOSカーネルを
調整します。そのため、RTOSではなくアプリケーション固有のファイルで
あり、RTOSカーネルのソースコードディレクトリではなくアプリケーション
ディレクトリに配置する必要があります。

プロジェクトにheap_1、heap_2、heap_4、heap_5が含まれている場合、
FreeRTOSConfig.hの定義`configTOTAL_HEAP_SIZE`はFreeRTOSnのヒープの
大きさを指定します。configTOTAL_HEAP_SIZEが大きすぎると
アプリケーションはリンクされません。

FreeRTOSConfig.hの定義`configMINIMAL_STACK_SIZE`はアイドルタスクが
使用するスタックのサイズを設定します。configMINIMAL_STACK_SIZEが
小さすぎるとアイドルタスクはスタックオーバーフローを起こします。configMINIMAL_STACK_SIZEには同一のマイクロコントローラアーキテクチャ
用に提供されている公式のFreeRTOSデモの値をコピーすることを勧めます。
FreeRTOSデモプロジェクトは`FreeRTOS/Demo`ディレクトリのサブ
ディレクトリに格納されています。デモプロジェクトの中には古いために
利用可能なすべての構成オプションが含まれていないものがあることに
注意してください。

アプリケーションの作者はFreeRTOSConfig.hテンプレートを出発点として
自身のアプリケーション用のFreeRTOSConfig.hファイルを作成することが
できます。

### 割り込みベクタ

（Cortex-Mユーザに注意: 割り込みハンドラのインストールに関する情報は
FAQの「作成したアプリケーションはコンパイルできますが実行されません」
に記載されています）

すべてのRTOSポートは周期的なティック割り込みを生成するために
タイマーを使用します。多くのポートはコンテキストスイッチを管理する
ために他の割り込みも使用します。RTOSポートが必要とする割り込みは
提供されているRTOSポートのソースファイルで処理されます。

RTOSポートが提供している割り込みハンドラのインストール方法は
使用するポー トとコンパイラに依存します。使用するポートの公式デモ
アプリケーションを参照し、必要に応じてコピーしてください。また、
公式デモアプリケーションのドキュメントページも参照してください。
